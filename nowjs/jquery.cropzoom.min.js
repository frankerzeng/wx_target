(function(a){a.fn.cropzoom=function(b){return this.each(function(){var e=null;var C=null;var c=null;var d=null;var A=null;var n={width:500,height:375,bgColor:"#000",overlayColor:"#000",selector:{x:0,y:0,w:229,h:100,aspectRatio:false,centered:false,borderColor:"yellow",borderColorHover:"red",bgInfoLayer:"#FFF",infoFontSize:10,infoFontColor:"blue",showPositionsOnDrag:true,showDimetionsOnDrag:true,maxHeight:null,maxWidth:null,startWithOverlay:false,hideOverlayOnDragAndResize:true,onSelectorDrag:null,onSelectorDragStop:null,onSelectorResize:null,onSelectorResizeStop:null},image:{source:"",rotation:0,width:0,height:0,minZoom:10,maxZoom:150,startZoom:0,x:0,y:0,useStartZoomAsMinZoom:false,snapToContainer:false,onZoom:null,onRotate:null,onImageDrag:null},enableRotation:true,enableZoom:true,zoomSteps:1,rotationSteps:5,expose:{slidersOrientation:"vertical",zoomElement:"",rotationElement:"",elementMovement:"",movementSteps:5}};var r=a.extend(true,n,b);if(!a.isFunction(a.fn.draggable)||!a.isFunction(a.fn.resizable)||!a.isFunction(a.fn.slider)){alert("You must include ui.draggable, ui.resizable and ui.slider to use cropZoom");return}if(r.image.source==""||r.image.width==0||r.image.height==0){alert("网络异常，请重新选择图片");return}e=a(this);f("options",r);e.empty();e.css({width:r.width,height:r.height,"background-color":r.bgColor,overflow:"hidden",position:"relative",border:"2px solid #333"});f("image",{h:r.image.height,w:r.image.width,posY:r.image.y,posX:r.image.x,scaleX:0,scaleY:0,rotation:r.image.rotation,source:r.image.source,bounds:[0,0,0,0],id:"image_to_crop_"+e[0].id});v();j();f("selector",{x:r.selector.x,y:r.selector.y,w:(r.selector.maxWidth!=null?(r.selector.w>r.selector.maxWidth?r.selector.maxWidth:r.selector.w):r.selector.w),h:(r.selector.maxHeight!=null?(r.selector.h>r.selector.maxHeight?r.selector.maxHeight:r.selector.h):r.selector.h)});$container=a("<div />").attr("id","k").css({width:r.width,height:r.height,position:"absolute"});d=a("<img />");d.attr("src",r.image.source);a(d).css({position:"absolute",left:o("image").posX,top:o("image").posY,width:o("image").w,height:o("image").h});var g=p();if(g=="png"||g=="gif"){}$container.append(d);e.append($container);B();a(d).draggable({refreshPositions:true,drag:function(D,E){o("image").posY=E.position.top;o("image").posX=E.position.left;if(r.image.snapToContainer){u(E)}else{B()}if(r.image.onImageDrag!=null){r.image.onImageDrag(d)}},stop:function(D,E){if(r.image.snapToContainer){u(E)}}});i();e.find(".ui-icon-gripsmall-diagonal-se").css({background:"#FFF",border:"1px solid #000",width:8,height:8});m();if(r.selector.startWithOverlay){var q={position:{top:c.position().top,left:c.position().left}};y(q)}if(r.enableZoom){l()}if(r.enableRotation){s()}if(r.expose.elementMovement!=""){w()}function u(F){if(F.position.top>0){o("image").posY=0}if(F.position.left>0){o("image").posX=0}var D=-(o("image").h-F.helper.parent().parent().height()),E=-(o("image").w-F.helper.parent().parent().width());if(F.position.top<D){o("image").posY=D}if(F.position.left<E){o("image").posX=E}B()}function p(){var D=r.image.source.split(".");return D[D.length-1]}function v(){o("image").scaleX=(r.width/o("image").w);o("image").scaleY=(r.height/o("image").h)}function j(){if(r.image.startZoom!=0){var G=((r.image.width*Math.abs(r.image.startZoom))/100);var F=((r.image.height*Math.abs(r.image.startZoom))/100);o("image").h=F;o("image").w=G;if(o("image").posY!=0&&o("image").posX!=0){if(o("image").h>r.height){o("image").posY=Math.abs((r.height/2)-(o("image").h/2))}else{o("image").posY=((r.height/2)-(o("image").h/2))}if(o("image").w>r.width){o("image").posX=Math.abs((r.width/2)-(o("image").w/2))}else{o("image").posX=((r.width/2)-(o("image").w/2))}}}else{var E=o("image").scaleX;var D=o("image").scaleY;if(D<E){o("image").h=r.height;o("image").w=Math.round(o("image").w*D)}else{o("image").h=Math.round(o("image").h*E);o("image").w=r.width}}if(o("image").w<r.width&&o("image").h<r.height){r.image.snapToContainer=false}B()}function B(){a(function(){t();rotation="rotate("+o("image").rotation+"deg)";a(d).css({transform:rotation,"-webkit-transform":rotation,"-ms-transform":rotation,msTransform:rotation,top:o("image").posY,left:o("image").posX})})}function s(){var I=a("<div />").attr("id","rotationContainer").mouseover(function(){a(this).css("opacity",1)}).mouseout(function(){a(this).css("opacity",0.6)});var G=a("<div />").attr("id","rotationMin").html("0");var E=a("<div />").attr("id","rotationMax").html("360");var H=a("<div />").attr("id","rotationSlider");var D="vertical";var F=Math.abs(360-r.image.rotation);if(r.expose.slidersOrientation=="horizontal"){D="horizontal";F=r.image.rotation}H.slider({orientation:D,value:F,range:"max",min:0,max:360,step:((r.rotationSteps>360||r.rotationSteps<0)?1:r.rotationSteps),slide:function(J,K){o("image").rotation=(F==360?Math.abs(360-K.value):Math.abs(K.value));B();if(r.image.onRotate!=null){r.image.onRotate(H,o("image").rotation)}}});I.append(G);I.append(H);I.append(E);if(r.expose.rotationElement!=""){H.addClass(r.expose.slidersOrientation);I.addClass(r.expose.slidersOrientation);G.addClass(r.expose.slidersOrientation);E.addClass(r.expose.slidersOrientation);a(r.expose.rotationElement).empty().append(I)}else{H.addClass("vertical");I.addClass("vertical");G.addClass("vertical");E.addClass("vertical");I.css({position:"absolute",top:5,left:5,opacity:0.6});e.append(I)}}function l(){var E=a("<div />").attr("id","zoomContainer").mouseover(function(){a(this).css("opacity",1)}).mouseout(function(){a(this).css("opacity",0.6)});var D=a("<div />").attr("id","zoomMin").html("<b>-</b>");var G=a("<div />").attr("id","zoomMax").html("<b>+</b>");var F=a("<div />").attr("id","zoomSlider");F.slider({orientation:(r.expose.zoomElement!=""?r.expose.slidersOrientation:"vertical"),value:(r.image.startZoom!=0?r.image.startZoom:h(o("image"))),min:(r.image.useStartZoomAsMinZoom?r.image.startZoom:r.image.minZoom),max:r.image.maxZoom,step:((r.zoomSteps>r.image.maxZoom||r.zoomSteps<0)?1:r.zoomSteps),slide:function(I,M){var N=(r.expose.slidersOrientation=="vertical"?(r.image.maxZoom-M.value):M.value);var L=(r.image.width*Math.abs(N)/100);var O=(r.image.height*Math.abs(N)/100);a(d).css({width:L+"px",height:O+"px"});var K=(o("image").w/2)-(L/2);var J=(o("image").h/2)-(O/2);var H=(K>0?o("image").posX+Math.abs(K):o("image").posX-Math.abs(K));var P=(J>0?o("image").posY+Math.abs(J):o("image").posY-Math.abs(J));o("image").posX=H;o("image").posY=P;o("image").w=L;o("image").h=O;v();B();if(r.image.onZoom!=null){r.image.onZoom(d,o("image"))}}});if(r.slidersOrientation=="vertical"){E.append(G);E.append(F);E.append(D)}else{E.append(D);E.append(F);E.append(G)}if(r.expose.zoomElement!=""){D.addClass(r.expose.slidersOrientation);G.addClass(r.expose.slidersOrientation);F.addClass(r.expose.slidersOrientation);E.addClass(r.expose.slidersOrientation);a(r.expose.zoomElement).empty().append(E)}else{D.addClass("vertical");G.addClass("vertical");F.addClass("vertical");E.addClass("vertical");E.css({position:"absolute",top:5,right:5,opacity:0.6});e.append(E)}}function h(){var D=0;if(o("image").w>o("image").h){D=r.image.maxZoom-((o("image").w*100)/r.image.width)}else{D=r.image.maxZoom-((o("image").h*100)/r.image.height)}return D}function i(){if(r.selector.centered){o("selector").y=(r.height/2)-(o("selector").h/2);o("selector").x=(r.width/2)-(o("selector").w/2)}c=a("<div/>").attr("id",e[0].id+"_selector").css({width:o("selector").w,height:o("selector").h,top:o("selector").y+"px",left:o("selector").x+"px",border:"1px dashed "+r.selector.borderColor,position:"absolute",cursor:"move"}).mouseover(function(){a(this).css({border:"1px dashed "+r.selector.borderColorHover})}).mouseout(function(){a(this).css({border:"1px dashed "+r.selector.borderColor})});c.draggable({containment:"parent",iframeFix:true,refreshPositions:true,drag:function(D,E){o("selector").x=E.position.left;o("selector").y=E.position.top;y(E);k();if(r.selector.onSelectorDrag!=null){r.selector.onSelectorDrag(c,o("selector"))}},stop:function(D,E){if(r.selector.hideOverlayOnDragAndResize){x()}if(r.selector.onSelectorDragStop!=null){r.selector.onSelectorDragStop(c,o("selector"))}}});c.resizable({aspectRatio:r.selector.aspectRatio,maxHeight:r.selector.maxHeight,maxWidth:r.selector.maxWidth,minHeight:r.selector.h,minWidth:r.selector.w,containment:"parent",resize:function(D,E){o("selector").w=c.width();o("selector").h=c.height();y(E);k();if(r.selector.onSelectorResize!=null){r.selector.onSelectorResize(c,o("selector"))}},stop:function(D,E){if(r.selector.hideOverlayOnDragAndResize){x()}if(r.selector.onSelectorResizeStop!=null){r.selector.onSelectorResizeStop(c,o("selector"))}}});k(c);e.append(c)}function k(){var D=null;var E=false;if(c.find("#infoSelector").length>0){D=c.find("#infoSelector")}else{D=a("<div />").attr("id","infoSelector").css({position:"absolute",top:0,left:0,background:r.selector.bgInfoLayer,opacity:0.6,"font-size":r.selector.infoFontSize+"px","font-family":"Arial",color:r.selector.infoFontColor,width:"100%"})}if(r.selector.showPositionsOnDrag){D.html("X:"+Math.round(o("selector").x)+"px - Y:"+Math.round(o("selector").y)+"px");E=true}if(r.selector.showDimetionsOnDrag){if(E){D.html(D.html()+" | W:"+o("selector").w+"px - H:"+o("selector").h+"px")}else{D.html("W:"+o("selector").w+"px - H:"+o("selector").h+"px")}}c.append(D)}function m(){var D=["t","b","l","r"];a.each(D,function(){var E=a("<div />").attr("id",this).css({overflow:"hidden",background:r.overlayColor,opacity:0.6,position:"absolute","z-index":2,visibility:"visible"});e.append(E)})}function y(D){e.find("#t").css({display:"block",width:r.width,height:D.position.top,left:0,top:0});e.find("#b").css({display:"block",width:r.width,height:r.height,top:(D.position.top+c.height())+"px",left:0});e.find("#l").css({display:"block",left:0,top:D.position.top,width:D.position.left,height:c.height()});e.find("#r").css({display:"block",top:D.position.top,left:(D.position.left+c.width())+"px",width:r.width,height:c.height()+"px"})}e.makeOverlayPositions=y;function x(){e.find("#t").hide();e.find("#b").hide();e.find("#l").hide();e.find("#r").hide()}function f(D,E){e.data(D,E)}function o(D){return e.data(D)}function t(){var K=o("image").rotation*Math.PI/180;var M=Math.sin(K);var P=Math.cos(K);var H=P*o("image").w;var O=M*o("image").w;var G=-M*o("image").h;var N=P*o("image").h;var E=P*o("image").w-M*o("image").h;var L=M*o("image").w+P*o("image").h;var J=Math.min(0,H,G,E);var F=Math.max(0,H,G,E);var I=Math.min(0,O,N,L);var D=Math.max(0,O,N,L);o("image").rotW=F-J;o("image").rotH=D-I;o("image").rotY=I;o("image").rotX=J}function w(){var F=a("<table>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    </table>");var E=[];E.push(a("<div />").addClass("mvn_no mvn"));E.push(a("<div />").addClass("mvn_n mvn"));E.push(a("<div />").addClass("mvn_ne mvn"));E.push(a("<div />").addClass("mvn_o mvn"));E.push(a("<div />").addClass("mvn_c"));E.push(a("<div />").addClass("mvn_e mvn"));E.push(a("<div />").addClass("mvn_so mvn"));E.push(a("<div />").addClass("mvn_s mvn"));E.push(a("<div />").addClass("mvn_se mvn"));for(var D=0;D<E.length;D++){E[D].mousedown(function(){z(this)}).mouseup(function(){clearTimeout(C)}).mouseout(function(){clearTimeout(C)});F.find("td:eq("+D+")").append(E[D])}a(r.expose.elementMovement).empty().append(F)}function z(F){if(a(F).hasClass("mvn_no")){o("image").posX=(o("image").posX-r.expose.movementSteps);o("image").posY=(o("image").posY-r.expose.movementSteps)}else{if(a(F).hasClass("mvn_n")){o("image").posY=(o("image").posY-r.expose.movementSteps)}else{if(a(F).hasClass("mvn_ne")){o("image").posX=(o("image").posX+r.expose.movementSteps);o("image").posY=(o("image").posY-r.expose.movementSteps)}else{if(a(F).hasClass("mvn_o")){o("image").posX=(o("image").posX-r.expose.movementSteps)}else{if(a(F).hasClass("mvn_c")){o("image").posX=(r.width/2)-(o("image").w/2);o("image").posY=(r.height/2)-(o("image").h/2)}else{if(a(F).hasClass("mvn_e")){o("image").posX=(o("image").posX+r.expose.movementSteps)}else{if(a(F).hasClass("mvn_so")){o("image").posX=(o("image").posX-r.expose.movementSteps);o("image").posY=(o("image").posY+r.expose.movementSteps)}else{if(a(F).hasClass("mvn_s")){o("image").posY=(o("image").posY+r.expose.movementSteps)}else{if(a(F).hasClass("mvn_se")){o("image").posX=(o("image").posX+r.expose.movementSteps);o("image").posY=(o("image").posY+r.expose.movementSteps)}}}}}}}}}if(r.image.snapToContainer){if(o("image").posY>0){o("image").posY=0}if(o("image").posX>0){o("image").posX=0}var D=-(o("image").h-e.height());var E=-(o("image").w-e.width());if(o("image").posY<D){o("image").posY=D}if(o("image").posX<E){o("image").posX=E}}B();C=setTimeout(function(){z(F)},100)}a.fn.cropzoom.updateOverlayPosition=function(D){e.makeOverlayPositions(D)};a.fn.cropzoom.getParameters=function(E,G){var H=E.data("image");var D=E.data("selector");var F={viewPortW:E.width(),viewPortH:E.height(),imageX:H.posX,imageY:H.posY,imageRotate:H.rotation,imageW:H.w,imageH:H.h,imageSource:H.source,selectorX:D.x,selectorY:D.y,selectorW:D.w,selectorH:D.h};return a.extend(F,G)};a.fn.cropzoom.getSelf=function(){return e};return this})};a.fn.extend({setSelector:function(c,i,d,f,e){var b=a(this);b.data("selector",{x:c,y:i,w:d,h:f});var g={position:{top:i,left:c}};if(e!=undefined&&e==true){b.find("#"+b[0].id+"_selector").animate({top:i,left:c,width:d,height:f},"slow",function(){if(b.data("options").selector.startWithOverlay){b.cropzoom.updateOverlayPosition(g)}})}else{b.find("#"+b[0].id+"_selector").css({top:i,left:c,width:d,height:f});if(a(this).data("options").selector.startWithOverlay){b.cropzoom.updateOverlayPosition(g)}}},setImage:function(d){var c=a(this);var b=c.data("options");a.each(d,function(e,f){b.image[e]=f});c.cropzoom(b)},restore:function(){var c=a(this);var b=c.data("options");c.empty();c.data("image",{});c.data("selector",{});if(b.expose.zoomElement!=""){a(b.expose.zoomElement).empty()}if(b.expose.rotationElement!=""){a(b.expose.rotationElement).empty()}if(b.expose.elementMovement!=""){a(b.expose.elementMovement).empty()}c.cropzoom(b)},send:function(d,e,f,g){var b=a(this);var c="";a.ajax({url:d,type:e,data:(b.cropzoom.getParameters(b,f)),success:function(h){b.data("imageResult",h);if(g!==undefined&&g!=null){g(h)}}})}})})(jQuery);
/*!
 * jQuery UI Touch Punch 0.2.2
 *
 * Copyright 2011, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
(function(b){b.support.touch="ontouchend" in document;if(!b.support.touch){return}var c=b.ui.mouse.prototype,e=c._mouseInit,a;function d(g,h){if(g.originalEvent.touches.length>1){return}g.preventDefault();var i=g.originalEvent.changedTouches[0],f=document.createEvent("MouseEvents");f.initMouseEvent(h,true,true,window,1,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);g.target.dispatchEvent(f)}c._touchStart=function(g){var f=this;if(a||!f._mouseCapture(g.originalEvent.changedTouches[0])){return}a=true;f._touchMoved=false;d(g,"mouseover");d(g,"mousemove");d(g,"mousedown")};c._touchMove=function(f){if(!a){return}this._touchMoved=true;d(f,"mousemove")};c._touchEnd=function(f){if(!a){return}d(f,"mouseup");d(f,"mouseout");if(!this._touchMoved){d(f,"click")}a=false};c._mouseInit=function(){var f=this;f.element.bind("touchstart",b.proxy(f,"_touchStart")).bind("touchmove",b.proxy(f,"_touchMove")).bind("touchend",b.proxy(f,"_touchEnd"));e.call(f)}})(jQuery);